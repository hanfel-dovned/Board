<!DOCTYPE html>
<html>
  <head>
    <title>Board</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        line-height: 0;
      }
      .board {
        width: 300px;
        height: 450px;
        border: 1px solid black;
        box-sizing: border-box;
        margin: 0;
      }
      .board-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-content: start;
        margin: 20px;
      }
      #edit-div {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      #follow-div {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      #edit-btn {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="board-container-wrapper">
      <div id="board-container" class="board-container"></div>
    </div><br>
    <button id="edit-toggle">Edit My Board</button>
    <div id="edit-div" style="display: none;">
      <textarea id="contentBox" rows="10" cols="50" placeholder="Regular text or HTML"></textarea><br><br>
      <label for="bg-color-picker">Background Color:</label>
      <input type="color" id="bg-color-picker"><br><br>
      <label for="text-color-picker">Text Color:</label>
      <input type="color" id="text-color-picker"><br><br>
      <button onclick="postEditBoard()" id="edit-btn">Save Changes</button><br><br>
    </div>
    <button id="follow-toggle">Follow or Unfollow</button>
    <div id="follow-div" style="display: none;">
      <input id="followBox"placeholder="~sampel-palnet"></input><br><br>
      <button onclick="postFollow()" id="follow-btn">Follow</button><br><br>
      <button onclick="postUnfollow()" id="unfollow-btn">Unfollow</button><br><br>
    </div>

    <script>

    function post(tag, data) {
        fetch('/apps/board', {
            method: 'POST',
            body: JSON.stringify({[tag]: data})
        })
    }

    function postFollow()
    {
        post("follow", document.getElementById('followBox').value);
    }

    function postUnfollow()
    {
        post("unfollow", document.getElementById('followBox').value);
    }

    function postEditBoard()
    {
        var editDiv = document.getElementById("edit-div");
        editDiv.style.display = "none";
          
        post("edit-board", [document.getElementById('contentBox').value,
                            document.getElementById('bg-color-picker').value.split("#")[1],
                            document.getElementById('text-color-picker').value.split("#")[1]]);
    }

    getState()
      .then((state) => renderPage(state))

    async function getState() {
      const response = await fetch('/apps/board/state')
      return response.json()
    }

    function createBoardIframe(ownerName, content, bgColor, textColor) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('board-wrapper');

      const iframe = document.createElement('iframe');
      iframe.id = ownerName;
      iframe.classList.add('board');
      iframe.style.backgroundColor = bgColor;
      iframe.srcdoc = `<style>body { color: ${textColor}; }</style>${content}`;

      wrapper.appendChild(iframe);
      return wrapper;
    }

    function renderPage(state)
    {   
        const myship = state[0];
        const boardData = state.slice(1);

        const container = document.getElementById("board-container");

        for (const object of boardData) {
          const key = Object.keys(object)[0];
          const board = object[key];
          const ownerName = key;

          const content = board[0].text;
          const bgColor = "#" + board[1]["bg-color"].substring(2).replace('.', '');
          const textColor = "#" + board[2]["text-color"].substring(2).replace('.', '');

          const boardIframe = createBoardIframe(ownerName, content, bgColor, textColor);

          if(content != "" || bgColor != "#ffffff" || ownerName == myship)
            container.appendChild(boardIframe);
        }

        let myBoard = {};

        for (let i = 0; i < boardData.length; i++) {
          if (myship in boardData[i]) {
            myBoard = boardData[i][myship];
            break;
          }
        }

        document.getElementById("contentBox").value = myBoard[0]["text"];
        document.getElementById("bg-color-picker").value = "#" + myBoard[1]["bg-color"].substring(2).replace('.', '');
        document.getElementById("text-color-picker").value = "#" + myBoard[2]["text-color"].substring(2).replace('.', '');

        document.getElementById("edit-toggle").addEventListener("click", function() {
          var editDiv = document.getElementById("edit-div");
          if (editDiv.style.display === "none") {
            editDiv.style.display = "block";
          } else {
            editDiv.style.display = "none";
          }
        });

        document.getElementById("follow-toggle").addEventListener("click", function() {
          var followDiv = document.getElementById("follow-div");
          if (followDiv.style.display === "none") {
            followDiv.style.display = "block";
          } else {
            followDiv.style.display = "none";
          }
        });

        const contentBox = document.getElementById("contentBox");
        const bgPicker = document.getElementById("bg-color-picker");
        const textPicker = document.getElementById("text-color-picker");
        
        contentBox.addEventListener("input", function() {
          const newValue = this.value;
          const boardIframe = document.getElementById(myship);
          boardIframe.srcdoc = newValue;
        });

        bgPicker.addEventListener("input", function() {
          const newValue = this.value;
          const boardIframe = document.getElementById(myship);
          boardIframe.style.backgroundColor = newValue;
        });

        textPicker.addEventListener("input", function() {
          const newValue = this.value;
          const boardIframe = document.getElementById(myship);
          const currentSrcdoc = boardIframe.srcdoc;
          const updatedSrcdoc = currentSrcdoc.replace(/<style>body { color: (.*?); }<\/style>/, `<style>body { color: ${newValue}; }</style>`);
          boardIframe.srcdoc = updatedSrcdoc;
        });
    }
    </script>
  </body>
</html>
