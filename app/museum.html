<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Museum</title>
    <style>
      body {
        margin: 0;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://unpkg.com/three-mesh-ui"></script>
    <script>
getState()
  .then((state) => renderPage(state))

async function getState() {
  const response = await fetch('/apps/board/state')
  return response.json()
}

function renderPage(state)
{
  const boardData = state.slice(1);

  // Basic three.js setup
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // White room
  const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
  const floorGeometry = new THREE.PlaneGeometry(10, 10);
  const floor = new THREE.Mesh(floorGeometry, wallMaterial);
  floor.rotation.x = -Math.PI / 2;
  floor.position.y = -2;
  scene.add(floor);

  const ceilingGeometry = new THREE.PlaneGeometry(10, 10);
  const ceiling = new THREE.Mesh(ceilingGeometry, wallMaterial);
  ceiling.rotation.x = Math.PI / 2;
  ceiling.position.y = 2.5;
  scene.add(ceiling);

  const wallGeometry = new THREE.PlaneGeometry(10, 5);
  const leftWall = new THREE.Mesh(wallGeometry, wallMaterial);
  leftWall.rotation.y = Math.PI / 2;
  leftWall.position.x = -5;
  scene.add(leftWall);

  const rightWall = new THREE.Mesh(wallGeometry, wallMaterial);
  rightWall.rotation.y = -Math.PI / 2;
  rightWall.position.x = 5;
  scene.add(rightWall);

  const frontWall = new THREE.Mesh(wallGeometry, wallMaterial);
  frontWall.position.z = -5;
  scene.add(frontWall);

  const backWall = new THREE.Mesh(wallGeometry, wallMaterial);
  backWall.position.z = 5;
  backWall.rotation.y = Math.PI;
  scene.add(backWall);

  function formatColorString(colorString) {
    const parts = colorString.split("x");
    const decimalColor = parseInt(parts[1], 16);
    return decimalColor.toString(16).padStart(6, "0");
  }


  function createHTMLRectangle(width, height, text, bgColor, textColor) {
    const container = new ThreeMeshUI.Block({
      width: width,
      height: height,
      padding: 0.05,
      alignContent: 'left',
      fontFamily: 'https://unpkg.com/three-mesh-ui/examples/assets/Roboto-msdf.json',
      fontTexture: 'https://unpkg.com/three-mesh-ui/examples/assets/Roboto-msdf.png',
      backgroundColor: new THREE.Color(bgColor),
    });

    const textBlock = new ThreeMeshUI.Text({
      content: text,
      fontSize: .08,
      fontColor: new THREE.Color(textColor),
    });

    container.add(textBlock);

    return container;
  }


const spacing = 2.5 / 3;
const rectHeight = 4.5 / 3;
const rectWidth = 3 / 3;

boardData.forEach((item, index) => {
  const nestedArray = Object.values(item)[0] || [];
  const textData = nestedArray[0] || {};
  const text = textData.text || '';

  const bgColorData = nestedArray[1] || {};
  const bgColor = parseInt(`0x${formatColorString((bgColorData["bg-color"] || defaultBgColor).replace(".", ""))}`, 16);

  const textColorData = nestedArray[2] || {};
  const textColor = parseInt(`0x${formatColorString((textColorData["text-color"] || defaultTextColor).replace(".", ""))}`, 16);

  const rectangle = createHTMLRectangle(rectWidth, rectHeight, text, bgColor, textColor);

  const wallIndex = index % 4;
  const wallOffset = Math.floor(index / 4);
  const position = -2 + spacing * wallOffset;

  switch (wallIndex) {
    case 0: // Left wall
      rectangle.position.set(-4.9, 0, position);
      rectangle.rotation.y = Math.PI / 2;
      break;
    case 1: // Right wall
      rectangle.position.set(4.9, 0, position);
      rectangle.rotation.y = -Math.PI / 2;
      break;
    case 2: // Front wall
      rectangle.position.set(position, 0, -4.9);
      break;
    case 3: // Back wall
      rectangle.position.set(position, 0, 4.9);
      rectangle.rotation.y = Math.PI;
      break;
  }

  scene.add(rectangle);
});



  // Lighting
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
  scene.add(ambientLight);

  const pointLight = new THREE.PointLight(0xffffff, 0.4, 100);
  pointLight.position.set(0, 1.5, 0);
  scene.add(pointLight);

  // Pointer lock controls
  const controls = new THREE.PointerLockControls(camera, renderer.domElement);
  document.body.addEventListener("click", () => {
    controls.lock();
  });
  scene.add(controls.getObject());

  // Movement
  const moveSpeed = 0.1;
  const velocity = new THREE.Vector3();
  const direction = new THREE.Vector3();
  document.addEventListener("keydown", (event) => {
    switch (event.key) {
      case "w":
        direction.z = moveSpeed;
        break;
      case "s":
        direction.z = -moveSpeed;
        break;
      case "a":
        direction.x = -moveSpeed;
        break;
      case "d":
        direction.x = moveSpeed;
        break;
    }
  });
  document.addEventListener("keyup", (event) => {
    switch (event.key) {
      case "w":
      case "s":
        direction.z = 0;
        break;
      case "a":
      case "d":
        direction.x = 0;
        break;
    }
  });

  // Animation loop
  function animate() {
    requestAnimationFrame(animate);

    ThreeMeshUI.update();

    if (controls.isLocked) {
      velocity.x = direction.x;
      velocity.z = direction.z;
      controls.moveRight(velocity.x);
      controls.moveForward(velocity.z);
    }

    renderer.render(scene, camera);
  }

  animate();
}

    </script>
  </body>
</html>
